from sage.all import *
import psycopg2
import sys


@parallel
def compute_data_at_level(N):
    conn = psycopg2.connect("dbname='modabvar' host='localhost'")
    c = conn.cursor()

    # Proceed only if no matching rows exist
    c.execute("""SELECT COUNT(*) FROM J0 WHERE level={}""".format(N))
    if c.fetchall()[0][0]:
        return 0

    J = J0(N)

    # Compute label
    the_label = "J0({})".format(N)

    # Compute level
    level = N

    # Compute dimension
    dimension = J.dimension()

    # Compute rational cusp subgroup
    # This is the group generated by differences of rational cusps
    Q_cusp_subgroup = J.rational_cusp_subgroup().order()

    # Compute rational cuspidal subgroup
    # This is the group generated by differences of cusps that are rational
    Q_cuspidal_subgroup = J.rational_cuspidal_subgroup().order()

    # Compute the cuspidal subgroup
    cuspidal_subgroup = J.cuspidal_subgroup().order()

    # Compute a multiple of the rational torsion order
    multiple_of_Q_torsion = \
        J.rational_torsion_subgroup().multiple_of_order(100)

    # See if certain values disagree
    disagree = Q_cuspidal_subgroup == multiple_of_Q_torsion

    # Insert into table
    c.execute("""INSERT INTO J0 (
            the_label,
            level,
            dimension,
            Q_cusp_subgroup,
            Q_cuspidal_subgroup,
            cuspidal_subgroup,
            multiple_of_Q_torsion,
            disagree
            )
            VALUES (
            '{}',
            {},
            {},
            {},
            {},
            {},
            {},
            {}
            )
    """.format(
        the_label,
        level,
        dimension,
        Q_cusp_subgroup,
        Q_cuspidal_subgroup,
        cuspidal_subgroup,
        multiple_of_Q_torsion,
        disagree
        )
    )
    conn.commit()
    conn.close()


conn = psycopg2.connect("dbname='modabvar' host='localhost'")
c = conn.cursor()

c.execute("""CREATE TABLE IF NOT EXISTS J0
        (
        the_label TEXT,
        level BIGINT PRIMARY KEY,
        dimension BIGINT,
        Q_cusp_subgroup BIGINT,
        Q_cuspidal_subgroup BIGINT,
        cuspidal_subgroup BIGINT,
        multiple_of_Q_torsion BIGINT,
        disagree BOOLEAN
        )
""")

conn.commit()
conn.close()

try:
    M = int(sys.argv[1])
except:
    M = 100

Ns = range(1, M+1)
list(compute_data_at_level(Ns))
